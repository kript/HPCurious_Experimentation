
# hint to run:
# ansible-playbook playbook.yml -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory -u vagrant


- name: setup wordpress and utilities
  hosts: all
  sudo: True

  vars:
    http_port: 80
    domain: hpcurious.com

  tasks:

  - name: add vagrant user to www-data group so it can read wordpress files
    user:
      name: vagrant
      groups: www-data
      append: yes

  - name: add domain to localhost so it thinks its authoratiative
    lineinfile: 
      dest: /etc/hosts 
      regexp: "^127.0.0.1 {{ domain }}" 
      line: "127.0.0.1 {{ domain }}" 
      owner: root 
      group: root 
      mode: 0644

  - name: install packages
    apt: name={{ item }} update_cache=yes state=latest
    with_items:
      - wordpress
      - curl
      - vim
      - mysql-server

  - name: enabled mod_rewrite
    apache2_module: name=rewrite state=present
    notify:
    - restart apache2

  - name: create virtual host file
    template: src=virtualhost.conf dest=/etc/apache2/sites-available/{{ domain }}.conf

  - name: enable virtual host file with a2ensite {{ domain }}
    command: a2ensite {{ domain }}
    args:
      creates: /etc/apache2/sites-enabled/{{ domain }}.conf
    notify:
    - restart apache2

  - name: Download WP-CLI
    shell: curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    args:
      creates: ./wp-cli.phar

  - name: Make WP-CLI executable
    file:
      path: ./wp-cli.phar
      mode: 0755

  - name: Copy WP-CLI to /usr/local/bin/wp
    command: cp ./wp-cli.phar /usr/local/bin/wp
    args:
      creates: /usr/local/bin/wp

  - name: download Bash Completion file for WP-CLI
    shell: curl -O https://raw.githubusercontent.com/wp-cli/wp-cli/master/utils/wp-completion.bash
    args:
      creates: ./wp-completion.bash

  - name: Copy wp-cli bash completion file to shared area
    command: cp ./wp-completion.bash /usr/local/etc/
    args:
      creates: /usr/local/etc/wp-completion.bash

  - name: add WP-CLI bash completion to .bash_profile
    lineinfile: 
      dest: /home/vagrant/.bash_profile
      line: source /usr/local/etc/wp-completion.bash
      create: yes
      owner: vagrant

  # worpress install notes from https://help.ubuntu.com/community/WordPress
  - name: make link for wordpress for apache destination
    file:
      src: /usr/share/wordpress
      dest: /var/www/wordpress
      state: link

  - name: chown /usr/share/wordpress to allow automatic updates to occur
    file:
      path: /usr/share/wordpress
      owner: www-data
      recurse: yes

  - name: uncompress wordpress/mysql setup script
    unarchive: 
      creates: /usr/share/doc/wordpress/examples/setup-mysql
      src: /usr/share/doc/wordpress/examples/setup-mysql.gz
      dest: /usr/share/doc/wordpress/examples/
      copy: no

  #Also sets up /srv/www/wp-content/{{ domain }}
  - name: Configure Wordpress for {{ domain }}
    command: bash /usr/share/doc/wordpress/examples/setup-mysql -n wordpress{{ domain }}
    args:
        creates: /etc/wordpress/config-{{ domain }}.php
    

  handlers:
    - name: restart apache2
      service: name=apache2 state=restarted
